<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Technician Admin Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f0f2f5;
    }
    .header {
      background: #007bff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }
    .header a {
      color: white;
      margin: 0 10px;
      text-decoration: none;
      font-weight: bold;
    }
    .header a:hover {
      text-decoration: underline;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .section h2 {
      margin: 0 0 10px;
      font-size: 1.5em;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .error, .success {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
    }
    .success {
      background: #d4edda;
      color: #155724;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
    th {
      background: #f4f4f4;
    }
    .inventory-item {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
    .inventory-item button {
      margin-left: 10px;
      background: #dc3545;
    }
    .inventory-item button:hover {
      background: #c82333;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2 style="margin: 0 10px;">Technician Admin Dashboard</h2>
    <div>
      <button onclick="logout()">Logout</button>
    </div>
  </div>
  <div class="container">
    <!-- About Section -->
    <div class="section">
      <h2>About</h2>
      <button onclick="fetchAbout()">Get Profile Info</button>
      <div id="about-result"></div>
      <p class="error" id="about-error"></p>
      <p class="success" id="about-success"></p>
    </div>

    <!-- Done Request Section -->
    <div class="section">
      <h2>Done Request</h2>
      <div class="form-group">
        <label for="done-requestId">Request ID</label>
        <input type="text" id="done-requestId" placeholder="Enter request ID">
      </div>
      <button onclick="doneRequest()">Mark as Done</button>
      <p class="error" id="done-error"></p>
      <p class="success" id="done-success"></p>
    </div>

    <!-- Refresh Access Token Section -->
    <div class="section">
      <h2>Refresh Access Token</h2>
      <button onclick="refreshAccessToken()">Refresh Token</button>
      <p class="error" id="refresh-error"></p>
      <p class="success" id="refresh-success"></p>
    </div>

    <!-- All Inventory Section -->
    <div class="section">
      <h2>All Inventory</h2>
      <button onclick="fetchAllInventory()">Get Inventory List</button>
      <div id="inventory-result"></div>
      <p class="error" id="inventory-error"></p>
      <p class="success" id="inventory-success"></p>
    </div>

    <!-- Use Inventories Section -->
    <div class="section">
      <h2>Use Inventories</h2>
      <div class="form-group">
        <label for="use-requestId">Request ID</label>
        <input type="text" id="use-requestId" placeholder="Enter request ID">
      </div>
      <div id="inventory-items">
        <div class="inventory-item" id="inventory-item-0">
          <div class="form-group">
            <label for="inventory-id-0">Inventory ID</label>
            <input type="text" id="inventory-id-0" placeholder="Enter inventory ID">
          </div>
          <div class="form-group">
            <label for="inventory-quantity-0">Quantity</label>
            <input type="number" id="inventory-quantity-0" min="1" placeholder="Enter quantity">
          </div>
          <button onclick="removeInventoryItem(0)">Remove</button>
        </div>
      </div>
      <button onclick="addInventoryItem()">Add Inventory Item</button>
      <button onclick="useInventories()">Use Inventories</button>
      <p class="error" id="use-inventory-error"></p>
      <p class="success" id="use-inventory-success"></p>
    </div>

    <!-- My Requests Section -->
    <div class="section">
      <h2>My Requests</h2>
      <button onclick="fetchMyRequests()">Get My Requests</button>
      <div id="requests-result"></div>
      <p class="error" id="requests-error"></p>
      <p class="success" id="requests-success"></p>
    </div>
  </div>

  <script src="/admin/global.js"></script>
  <script>
    // Umumiy xato boshqaruv funksiyasi
    function handleError(errorElement, successElement, resultElement, errorMessage) {
      errorElement.textContent = errorMessage;
      errorElement.style.display = 'block';
      if (successElement) successElement.style.display = 'none';
      if (resultElement) resultElement.innerHTML = '';
    }

    // Dinamik inventar maydonlari uchun counter
    let inventoryItemCount = 1;

    // Yangi inventar maydoni qo'shish
    function addInventoryItem() {
      const container = document.getElementById('inventory-items');
      const newItem = document.createElement('div');
      newItem.className = 'inventory-item';
      newItem.id = `inventory-item-${inventoryItemCount}`;
      newItem.innerHTML = `
        <div class="form-group">
          <label for="inventory-id-${inventoryItemCount}">Inventory ID</label>
          <input type="text" id="inventory-id-${inventoryItemCount}" placeholder="Enter inventory ID">
        </div>
        <div class="form-group">
          <label for="inventory-quantity-${inventoryItemCount}">Quantity</label>
          <input type="number" id="inventory-quantity-${inventoryItemCount}" min="1" placeholder="Enter quantity">
        </div>
        <button onclick="removeInventoryItem(${inventoryItemCount})">Remove</button>
      `;
      container.appendChild(newItem);
      inventoryItemCount++;
    }

    // Inventar maydonini o'chirish
    function removeInventoryItem(index) {
      const item = document.getElementById(`inventory-item-${index}`);
      if (item) item.remove();
    }

    function logout() {
      const result = fetch('/admin/api/auth/logout', { method: 'POST' });

      if (result) {
        window.location.href = '/admin/'; // Redirect to login page
      }
    }

    // About
    async function fetchAbout() {
      const error = document.getElementById('about-error');
      const success = document.getElementById('about-success');
      const result = document.getElementById('about-result');
      error.style.display = 'none';
      success.style.display = 'none';
      result.innerHTML = '';

      try {
        const response = await apiFetch('/admin/api/technician/about', { method: 'GET' }, 'read');
        if (!response) return; // 403 uchun /admin/login/ ga yo'naltiriladi

        const data = await response.json();
        if (!data.success || !data.data) {
          handleError(error, success, result, 'No profile data found');
          return;
        }

        result.innerHTML = `
          <p><strong>ID:</strong> ${data.data.id}</p>
          <p><strong>First Name:</strong> ${data.data.firstName}</p>
          <p><strong>Last Name:</strong> ${data.data.lastName}</p>
          <p><strong>Email:</strong> ${data.data.email}</p>
          <p><strong>Role:</strong> ${data.data.role}</p>
          <p><strong>KPI (Total Completed):</strong> ${data.data.kpi.totalCompleted}</p>
          <p><strong>KPI (Avg Completion Time):</strong> ${data.data.kpi.avgCompletionTime.toFixed(2)} minutes</p>
          <p><strong>Assigned Tasks:</strong> ${data.data.assignedTasks.join(', ') || 'None'}</p>
        `;
        success.textContent = 'Profile fetched successfully';
        success.style.display = 'block';
      } catch (err) {
        console.error('About error:', err);
        handleError(error, success, result, err.message || 'Something went wrong');
      }
    }

    // Done Request
    async function doneRequest() {
      const error = document.getElementById('done-error');
      const success = document.getElementById('done-success');
      error.style.display = 'none';
      success.style.display = 'none';

      const requestId = document.getElementById('done-requestId').value.trim();

      if (!requestId) {
        handleError(error, success, null, 'Request ID is required');
        return;
      }

      try {
        const response = await apiFetch('/admin/api/technician/done-request', {
          method: 'POST',
          body: JSON.stringify({ requestId }),
        }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success) {
          handleError(error, success, null, data.error || 'Failed to mark request as done');
          return;
        }

        success.textContent = 'Request marked as done successfully';
        success.style.display = 'block';
        document.getElementById('done-requestId').value = '';
      } catch (err) {
        console.error('Done request error:', err);
        handleError(error, success, null, err.message || 'Something went wrong');
      }
    }

    // Refresh Access Token
    async function refreshAccessToken() {
      const error = document.getElementById('refresh-error');
      const success = document.getElementById('refresh-success');
      error.style.display = 'none';
      success.style.display = 'none';

      try {
        const response = await apiFetch('/admin/api/technician/refresh-access-token', { method: 'POST' }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success) {
          handleError(error, success, null, 'Token refresh failed');
          return;
        }

        success.textContent = data.message || 'Token refreshed successfully';
        success.style.display = 'block';
      } catch (err) {
        console.error('Refresh token error:', err);
        handleError(error, success, null, err.message || 'Something went wrong');
      }
    }

    // All Inventory
    async function fetchAllInventory() {
      const error = document.getElementById('inventory-error');
      const success = document.getElementById('inventory-success');
      const result = document.getElementById('inventory-result');
      error.style.display = 'none';
      success.style.display = 'none';
      result.innerHTML = '';

      try {
        const response = await apiFetch('/admin/api/technician/all-inventory', { method: 'GET' }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success || !data.data) {
          handleError(error, success, result, 'No inventory found');
          return;
        }

        result.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Part Number</th>
                <th>Quantity</th>
                <th>Description</th>
                <th>Updated At</th>
              </tr>
            </thead>
            <tbody>
              ${data.data.map(inv => `
                <tr>
                  <td>${inv.id}</td>
                  <td>${inv.name}</td>
                  <td>${inv.partNumber || '-'}</td>
                  <td>${inv.quantity}</td>
                  <td>${inv.description || '-'}</td>
                  <td>${new Date(inv.updatedAt).toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        success.textContent = 'Inventory fetched successfully';
        success.style.display = 'block';
      } catch (err) {
        console.error('Fetch inventory error:', err);
        handleError(error, success, result, err.message || 'Something went wrong');
      }
    }

    // Use Inventories
    async function useInventories() {
      const error = document.getElementById('use-inventory-error');
      const success = document.getElementById('use-inventory-success');
      error.style.display = 'none';
      success.style.display = 'none';

      const requestId = document.getElementById('use-requestId').value.trim();
      const inventories = [];

      for (let i = 0; i < inventoryItemCount; i++) {
        const item = document.getElementById(`inventory-item-${i}`);
        if (!item) continue;

        const inventoryId = document.getElementById(`inventory-id-${i}`).value.trim();
        const quantity = parseInt(document.getElementById(`inventory-quantity-${i}`).value);

        if (inventoryId && !isNaN(quantity) && quantity >= 1) {
          inventories.push({ inventoryId, quantity });
        }
      }

      if (!requestId || inventories.length === 0) {
        handleError(error, success, null, 'Request ID and at least one valid inventory item are required');
        return;
      }

      try {
        const response = await apiFetch('/admin/api/technician/use-inventories', {
          method: 'POST',
          body: JSON.stringify({ requestId, inventories }),
        }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success) {
          handleError(error, success, null, data.error || 'Failed to use inventories');
          return;
        }

        success.textContent = 'Inventories used successfully';
        success.style.display = 'block';
        document.getElementById('use-requestId').value = '';
        const container = document.getElementById('inventory-items');
        container.innerHTML = `
          <div class="inventory-item" id="inventory-item-0">
            <div class="form-group">
              <label for="inventory-id-0">Inventory ID</label>
              <input type="text" id="inventory-id-0" placeholder="Enter inventory ID">
            </div>
            <div class="form-group">
              <label for="inventory-quantity-0">Quantity</label>
              <input type="number" id="inventory-quantity-0" min="1" placeholder="Enter quantity">
            </div>
            <button onclick="removeInventoryItem(0)">Remove</button>
          </div>
        `;
        inventoryItemCount = 1;
      } catch (err) {
        console.error('Use inventories error:', err);
        handleError(error, success, null, err.message || 'Something went wrong');
      }
    }

    // My Requests
    async function fetchMyRequests() {
      const error = document.getElementById('requests-error');
      const success = document.getElementById('requests-success');
      const result = document.getElementById('requests-result');
      error.style.display = 'none';
      success.style.display = 'none';
      result.innerHTML = '';

      try {
        const response = await apiFetch('/admin/api/technician/my-requests', { method: 'GET' }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success || !data.data) {
          handleError(error, success, result, 'No requests found');
          return;
        }

        result.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>User</th>
                <th>Type</th>
                <th>Issue Description</th>
                <th>Status</th>
                <th>Submitted At</th>
                <th>Assigned At</th>
                <th>Completed At</th>
              </tr>
            </thead>
            <tbody>
              ${data.data.map(req => `
                <tr>
                  <td>${req.id}</td>
                  <td>${req.user.firstName} ${req.user.lastName} (${req.user.email})</td>
                  <td>${req.type}</td>
                  <td>${req.issueDescription}</td>
                  <td>${req.status}</td>
                  <td>${new Date(req.submittedAt).toLocaleString()}</td>
                  <td>${req.assignedAt ? new Date(req.assignedAt).toLocaleString() : '-'}</td>
                  <td>${req.completedAt ? new Date(req.completedAt).toLocaleString() : '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        success.textContent = 'Requests fetched successfully';
        success.style.display = 'block';
      } catch (err) {
        console.error('Fetch requests error:', err);
        handleError(error, success, result, err.message || 'Something went wrong');
      }
    }
  </script>
</body>
</html>