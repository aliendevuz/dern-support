<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager Admin Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f0f2f5;
    }

    .header {
      background: #007bff;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: white;
    }

    .header a {
      color: white;
      margin: 0 10px;
      text-decoration: none;
      font-weight: bold;
    }

    .header a:hover {
      text-decoration: underline;
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
    }

    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .section h2 {
      margin: 0 0 10px;
      font-size: 1.5em;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #0056b3;
    }

    .error,
    .success {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      display: none;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
    }

    .success {
      background: #d4edda;
      color: #155724;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table,
    th,
    td {
      border: 1px solid #ddd;
    }

    th,
    td {
      padding: 10px;
      text-align: left;
    }

    th {
      background: #f4f4f4;
    }
  </style>
</head>

<body>
  <div class="header">
    <h2 style="margin: 0 10px;">Manager Admin Dashboard</h2>
    <div>
      <button onclick="logout()">Logout</button>
    </div>
  </div>
  <div class="container">
    <!-- About Section -->
    <div class="section">
      <h2>About</h2>
      <button onclick="fetchAbout()">Get Profile Info</button>
      <div id="about-result"></div>
      <p class="error" id="about-error"></p>
      <p class="success" id="about-success"></p>
    </div>

    <!-- Assign Request Section -->
    <div class="section">
      <h2>Assign Request</h2>
      <div class="form-group">
        <label for="assign-requestId">Request ID</label>
        <input type="text" id="assign-requestId" placeholder="Enter request ID">
      </div>
      <div class="form-group">
        <label for="assign-technicianId">Technician ID</label>
        <input type="text" id="assign-technicianId" placeholder="Enter technician ID">
      </div>
      <button onclick="assignRequest()">Assign Request</button>
      <p class="error" id="assign-error"></p>
      <p class="success" id="assign-success"></p>
    </div>

    <!-- Refresh Access Token Section -->
    <div class="section">
      <h2>Refresh Access Token</h2>
      <button onclick="refreshAccessToken()">Refresh Token</button>
      <p class="error" id="refresh-error"></p>
      <p class="success" id="refresh-success"></p>
    </div>

    <!-- All Inventory Section -->
    <div class="section">
      <h2>All Inventory</h2>
      <button onclick="fetchAllInventory()">Get Inventory List</button>
      <div id="inventory-result"></div>
      <p class="error" id="inventory-error"></p>
      <p class="success" id="inventory-success"></p>
    </div>

    <!-- Add Inventory Section -->
    <div class="section">
      <h2>Add Inventory</h2>
      <div class="form-group">
        <label for="add-name">Name</label>
        <input type="text" id="add-name" placeholder="Enter inventory name">
      </div>
      <div class="form-group">
        <label for="add-partNumber">Part Number</label>
        <input type="text" id="add-partNumber" placeholder="Enter part number (optional)">
      </div>
      <div class="form-group">
        <label for="add-quantity">Quantity</label>
        <input type="number" id="add-quantity" min="0" placeholder="Enter quantity">
      </div>
      <div class="form-group">
        <label for="add-description">Description</label>
        <textarea id="add-description" rows="4" placeholder="Enter description (optional)"></textarea>
      </div>
      <button onclick="addInventory()">Add Inventory</button>
      <p class="error" id="add-inventory-error"></p>
      <p class="success" id="add-inventory-success"></p>
    </div>

    <!-- Update Inventory Section -->
    <div class="section">
      <h2>Update Inventory</h2>
      <div class="form-group">
        <label for="update-inventoryId">Inventory ID</label>
        <input type="text" id="update-inventoryId" placeholder="Enter inventory ID">
      </div>
      <div class="form-group">
        <label for="update-name">Name</label>
        <input type="text" id="update-name" placeholder="Enter inventory name">
      </div>
      <div class="form-group">
        <label for="update-partNumber">Part Number</label>
        <input type="text" id="update-partNumber" placeholder="Enter part number (optional)">
      </div>
      <div class="form-group">
        <label for="update-quantity">Quantity</label>
        <input type="number" id="update-quantity" min="0" placeholder="Enter quantity">
      </div>
      <div class="form-group">
        <label for="update-description">Description</label>
        <textarea id="update-description" rows="4" placeholder="Enter description (optional)"></textarea>
      </div>
      <button onclick="updateInventory()">Update Inventory</button>
      <p class="error" id="update-inventory-error"></p>
      <p class="success" id="update-inventory-success"></p>
    </div>

    <!-- Delete Inventory Section -->
    <div class="section">
      <h2>Delete Inventory</h2>
      <div class="form-group">
        <label for="delete-inventoryId">Inventory ID</label>
        <input type="text" id="delete-inventoryId" placeholder="Enter inventory ID">
      </div>
      <button onclick="deleteInventory()">Delete Inventory</button>
      <p class="error" id="delete-inventory-error"></p>
      <p class="success" id="delete-inventory-success"></p>
    </div>

    <!-- All Requests Section for Manager -->
    <div class="section">
      <h2>All Support Requests</h2>
      <button onclick="fetchMyRequests()">Get All Requests</button>
      <div id="requests-result"></div>
      <p class="error" id="requests-error"></p>
      <p class="success" id="requests-success"></p>
    </div>

  </div>

  <script src="/admin/global.js"></script>
  <script>
    // Umumiy xato boshqaruv funksiyasi
    function handleError(errorElement, successElement, resultElement, errorMessage) {
      errorElement.textContent = errorMessage;
      errorElement.style.display = 'block';
      if (successElement) successElement.style.display = 'none';
      if (resultElement) resultElement.innerHTML = '';
    }

    // About
    async function fetchAbout() {
      const error = document.getElementById('about-error');
      const success = document.getElementById('about-success');
      const result = document.getElementById('about-result');
      error.style.display = 'none';
      success.style.display = 'none';
      result.innerHTML = '';

      try {
        const response = await apiFetch('/admin/api/manager/about', { method: 'GET' }, 'read');
        if (!response) return; // 403 uchun /admin/login/ ga yo'naltiriladi

        const data = await response.json();
        if (!data.success || !data.data) {
          handleError(error, success, result, 'No profile data found');
          return;
        }

        result.innerHTML = `
          <p><strong>ID:</strong> ${data.data.id}</p>
          <p><strong>First Name:</strong> ${data.data.firstName}</p>
          <p><strong>Last Name:</strong> ${data.data.lastName}</p>
          <p><strong>Email:</strong> ${data.data.email}</p>
          <p><strong>Role:</strong> ${data.data.role}</p>
        `;
        success.textContent = 'Profile fetched successfully';
        success.style.display = 'block';
      } catch (err) {
        console.error('About error:', err);
        handleError(error, success, result, err.message || 'Something went wrong');
      }
    }

    function logout() {
      const result = fetch('/admin/api/auth/logout', { method: 'POST' });

      if (result) {
        window.location.href = '/admin/'; // Redirect to login page
      }
    }

    // Assign Request
    async function assignRequest() {
      const error = document.getElementById('assign-error');
      const success = document.getElementById('assign-success');
      error.style.display = 'none';
      success.style.display = 'none';

      const requestId = document.getElementById('assign-requestId').value.trim();
      const technicianId = document.getElementById('assign-technicianId').value.trim();

      if (!requestId || !technicianId) {
        handleError(error, success, null, 'Request ID and Technician ID are required');
        return;
      }

      try {
        const response = await apiFetch('/admin/api/manager/assign-request', {
          method: 'POST',
          body: JSON.stringify({ requestId, technicianId }),
        }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success) {
          handleError(error, success, null, data.error || 'Request assignment failed');
          return;
        }

        success.textContent = 'Request assigned successfully';
        success.style.display = 'block';
        document.getElementById('assign-requestId').value = '';
        document.getElementById('assign-technicianId').value = '';
      } catch (err) {
        console.error('Assign request error:', err);
        handleError(error, success, null, err.message || 'Something went wrong');
      }
    }

    // Refresh Access Token
    async function refreshAccessToken() {
      const error = document.getElementById('refresh-error');
      const success = document.getElementById('refresh-success');
      error.style.display = 'none';
      success.style.display = 'none';

      try {
        const response = await apiFetch('/admin/api/manager/refresh-access-token', { method: 'POST' }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success) {
          handleError(error, success, null, 'Token refresh failed');
          return;
        }

        success.textContent = data.message || 'Token refreshed successfully';
        success.style.display = 'block';
      } catch (err) {
        console.error('Refresh token error:', err);
        handleError(error, success, null, err.message || 'Something went wrong');
      }
    }

    // All Inventory
    async function fetchAllInventory() {
      const error = document.getElementById('inventory-error');
      const success = document.getElementById('inventory-success');
      const result = document.getElementById('inventory-result');
      error.style.display = 'none';
      success.style.display = 'none';
      result.innerHTML = '';

      try {
        const response = await apiFetch('/admin/api/manager/all-inventory', { method: 'GET' }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success || !data.data) {
          handleError(error, success, result, 'No inventory found');
          return;
        }

        result.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Part Number</th>
                <th>Quantity</th>
                <th>Description</th>
                <th>Updated At</th>
              </tr>
            </thead>
            <tbody>
              ${data.data.map(inv => `
                <tr>
                  <td>${inv.id}</td>
                  <td>${inv.name}</td>
                  <td>${inv.partNumber || '-'}</td>
                  <td>${inv.quantity}</td>
                  <td>${inv.description || '-'}</td>
                  <td>${new Date(inv.updatedAt).toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        success.textContent = 'Inventory fetched successfully';
        success.style.display = 'block';
      } catch (err) {
        console.error('Fetch inventory error:', err);
        handleError(error, success, result, err.message || 'Something went wrong');
      }
    }

    // Add Inventory
    async function addInventory() {
      const error = document.getElementById('add-inventory-error');
      const success = document.getElementById('add-inventory-success');
      error.style.display = 'none';
      success.style.display = 'none';

      const name = document.getElementById('add-name').value.trim();
      const partNumber = document.getElementById('add-partNumber').value.trim();
      const quantity = parseInt(document.getElementById('add-quantity').value);
      const description = document.getElementById('add-description').value.trim();

      if (!name || isNaN(quantity) || quantity < 0) {
        handleError(error, success, null, 'Name and valid quantity are required');
        return;
      }

      try {
        const response = await apiFetch('/admin/api/manager/add-inventory', {
          method: 'POST',
          body: JSON.stringify({ name, partNumber, quantity, description }),
        }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success) {
          handleError(error, success, null, data.error || 'Failed to add inventory');
          return;
        }

        success.textContent = 'Inventory added successfully';
        success.style.display = 'block';
        document.getElementById('add-name').value = '';
        document.getElementById('add-partNumber').value = '';
        document.getElementById('add-quantity').value = '';
        document.getElementById('add-description').value = '';
      } catch (err) {
        console.error('Add inventory error:', err);
        handleError(error, success, null, err.message || 'Something went wrong');
      }
    }

    // Update Inventory
    async function updateInventory() {
      const error = document.getElementById('update-inventory-error');
      const success = document.getElementById('update-inventory-success');
      error.style.display = 'none';
      success.style.display = 'none';

      const inventoryId = document.getElementById('update-inventoryId').value.trim();
      const name = document.getElementById('update-name').value.trim();
      const partNumber = document.getElementById('update-partNumber').value.trim();
      const quantity = parseInt(document.getElementById('update-quantity').value);
      const description = document.getElementById('update-description').value.trim();

      if (!inventoryId || !name || isNaN(quantity) || quantity < 0) {
        handleError(error, success, null, 'Inventory ID, name, and valid quantity are required');
        return;
      }

      try {
        const response = await apiFetch('/admin/api/manager/update-inventory', {
          method: 'POST',
          body: JSON.stringify({ inventoryId, name, partNumber, quantity, description }),
        }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success) {
          handleError(error, success, null, data.error || 'Failed to update inventory');
          return;
        }

        success.textContent = 'Inventory updated successfully';
        success.style.display = 'block';
        document.getElementById('update-inventoryId').value = '';
        document.getElementById('update-name').value = '';
        document.getElementById('update-partNumber').value = '';
        document.getElementById('update-quantity').value = '';
        document.getElementById('update-description').value = '';
      } catch (err) {
        console.error('Update inventory error:', err);
        handleError(error, success, null, err.message || 'Something went wrong');
      }
    }

    // Delete Inventory
    async function deleteInventory() {
      const error = document.getElementById('delete-inventory-error');
      const success = document.getElementById('delete-inventory-success');
      error.style.display = 'none';
      success.style.display = 'none';

      const inventoryId = document.getElementById('delete-inventoryId').value.trim();

      if (!inventoryId) {
        handleError(error, success, null, 'Inventory ID is required');
        return;
      }

      try {
        const response = await apiFetch('/admin/api/manager/delete-inventory', {
          method: 'POST',
          body: JSON.stringify({ inventoryId }),
        }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success) {
          handleError(error, success, null, data.error || 'Failed to delete inventory');
          return;
        }

        success.textContent = data.message || 'Inventory deleted successfully';
        success.style.display = 'block';
        document.getElementById('delete-inventoryId').value = '';
      } catch (err) {
        console.error('Delete inventory error:', err);
        handleError(error, success, null, err.message || 'Something went wrong');
      }
    }

    // Fetch All Requests for Manager
    async function fetchMyRequests() {
      const error = document.getElementById('requests-error');
      const success = document.getElementById('requests-success');
      const result = document.getElementById('requests-result');
      error.style.display = 'none';
      success.style.display = 'none';
      result.innerHTML = '';

      try {
        const response = await apiFetch('/admin/api/manager/my-requests', { method: 'GET' }, 'read');
        if (!response) return;

        const data = await response.json();
        if (!data.success || !data.data) {
          handleError(error, success, result, 'No requests found');
          return;
        }

        result.innerHTML = `
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>User</th>
        <th>Type</th>
        <th>Issue</th>
        <th>Status</th>
        <th>Submitted</th>
        <th>Assigned</th>
        <th>Technician</th>
      </tr>
    </thead>
    <tbody>
      ${data.data.map(req => `
        <tr>
          <td>${req.id}</td>
          <td>
            ${req.user
            ? `${req.user.firstName} ${req.user.lastName} (${req.user.email})`
            : '<em>Unknown User</em>'}
          </td>
          <td>${req.type}</td>
          <td>${req.issueDescription}</td>
          <td>${req.status}</td>
          <td>${new Date(req.submittedAt).toLocaleString()}</td>
          <td>${req.assignedAt ? new Date(req.assignedAt).toLocaleString() : '-'}</td>
          <td>
            ${req.assignedTo
            ? `${req.assignedTo.firstName} ${req.assignedTo.lastName} (${req.assignedTo.email})`
            : '<em>Unassigned</em>'}
          </td>
        </tr>
      `).join('')}
    </tbody>
  </table>
`;

        success.textContent = 'Requests fetched successfully';
        success.style.display = 'block';
      } catch (err) {
        console.error('Fetch requests error:', err);
        handleError(error, success, result, err.message || 'Something went wrong');
      }
    }

  </script>
</body>

</html>